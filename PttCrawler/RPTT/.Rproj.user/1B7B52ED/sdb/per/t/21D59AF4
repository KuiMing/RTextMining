{
    "contents" : "# \n# library(httr)\n# library(XML)\n# library(dplyr)\n# \n# \n####################################################\n# getCityCodes via POST cityid\n####################################################\n\n#' getCityCodes via POST cityid\n#' \n#' getCityCodes via POST cityid\n#'\n#' @examples\n#' cityCodeDf = getCityCodes()\n#' View(cityCodeDf)\n#' @export\ngetCityCodes = function(){\n  # function input:\n  res = GET(\"http://emap.pcsc.com.tw/lib/areacode.js\")\n  resText = content(res,\"text\",encoding = \"utf8\")\n  matches = gregexpr(\"AreaNode[(][^,]+(,[^,]+){3}\",resText)\n  unlist(regmatches(resText,matches))\n  cityCodesStr = unlist(regmatches(resText,matches))\n  cityCodes = lapply(cityCodesStr[2:length(cityCodesStr)],function(str){\n    matches = gregexpr(\"[']([^']+)[']\",str)\n    return(gsub(\"'\",\"\",unlist(regmatches(str,matches))))\n  })\n  \n  cityCodesDf = data.frame(do.call(rbind,cityCodes),stringsAsFactors = FALSE)\n  colnames(cityCodesDf) = c(\"cityName\",\"cityCode\")\n  # function output:\n  return(cityCodesDf)\n}\n\n\n####################################################\n# getOneTownDf via POST cityid\n####################################################\n\n#' getOneTownDf via POST cityid\n#' \n#' getOneTownDf via POST cityid\n#' \n#' @examples\n#' View(getOneTownDf(\"01\"))\n#' \n#' @export\ngetOneTownDf = function(cityCode){\n  # function input: cityCode\n  # cityCode = \"09\"\n  # connector\n  res = POST(\"http://emap.pcsc.com.tw/EMapSDK.aspx\",\n             body=list(commandid=\"GetTown\",cityid=cityCode))\n  \n  # parser\n  node = xmlParse(content(res,as=\"text\"))\n  townDf = xmlToDataFrame(node[\"//GeoPosition\"],stringsAsFactors = FALSE)\n  if (dim(townDf)[1] > 0){\n    townDf = data.frame(cityCode=cityCode,townDf,stringsAsFactors = FALSE)\n    # function output:\n    return(townDf)  \n  }else{\n    return(NULL)\n  }\n  \n}\n\n\n####################################################\n# getTownDf via POST cityCodes\n####################################################\n\n#' getTownDf via POST cityCodes\n#' \n#' getTownDf via POST cityCodes\n#' \n#' @examples\n#' cityCodeDf = getCityCodes()\n#' townDf = getTownDf(cityCodeDf$cityCode)\n#' View(townDf)\n#' \n#' @export\ngetTownDf = function(cityCodes){\n  # function input: cityCodes\n  # cityCodes = cityCodesDf$cityCode\n  \n  listTownDfs = lapply(cityCodes,getOneTownDf)\n  \n  townDf = do.call(rbind,listTownDfs[!sapply(listTownDfs,is.null)])\n  townDf = inner_join(getCityCodes(),townDf,by = \"cityCode\")\n  # function output:\n  return(townDf)\n}\n\n\n####################################################\n# getStoreData via POST cityName and townName\n####################################################\n\n#' getStoreData via POST cityName and townName\n#' \n#' getStoreData via POST cityName and townName\n#' \n#' @examples\n#' cityCodeDf = getCityCodes()\n#' townDf = getTownDf(cityCodeDf$cityCode)\n#' testTownDf = townDf[,c(\"cityName\",\"TownName\")][1:10,]\n#' listOfData = apply(testTownDf,1,function(x){\n#'    print(getStoreData(x[1],x[2]))\n#' })\n#' totalDf = do.call(rbind,listOfData)\n#' View(totalDf)\n#' \n#' @export\ngetStoreData = function(cityName, townName){\n  # function input: cityName, townName\n  # cityName = \"台北市\"\n  # townName = \"大安區\"\n  \n  \n  # connector\n  res = POST(\"http://emap.pcsc.com.tw/EMapSDK.aspx\",\n             body=list(commandid=\"SearchStore\",city=cityName,town=townName))\n  \n  # parser\n  node = xmlParse(content(res,as=\"text\"))\n  storeDf = xmlToDataFrame(node[\"//GeoPosition\"])\n  # function output: \n  return(storeDf)\n}\n\n",
    "created" : 1431440678270.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1054550768",
    "id" : "21D59AF4",
    "lastKnownWriteTime" : 1431260529,
    "path" : "/project/CaseStudies/Case4SevenElevenAddress/RCrawlerTW711/R/RCrawlerTW711.R",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}